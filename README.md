# Z4l1nux AI Threat Lab

O **Z4l1nux AI Threat Lab** √© um laborat√≥rio avan√ßado de an√°lise de amea√ßas cibern√©ticas que implementa um sistema de Retrieval-Augmented Generation (RAG) em **TypeScript Full-Stack** com recursos avan√ßados de controle de vers√£o, cache inteligente e processamento incremental. O sistema √© especializado em an√°lise de threat modeling, detec√ß√£o de vulnerabilidades e gera√ß√£o de relat√≥rios de seguran√ßa automatizados, suportando modelos locais via Ollama e modelos remotos via OpenRouter (DeepSeek).

## üéØ **Nova Arquitetura Full-Stack TypeScript**

- **Frontend:** React 18 + TypeScript + Vite
- **Backend:** Node.js + Express + TypeScript  
- **Database:** Neo4j com suporte vetorial
- **IA:** Ollama (local) + OpenRouter (cloud)
- **Build:** TypeScript compilado + Vite bundling

## ‚ú® Funcionalidades do Z4l1nux AI Threat Lab

### üöÄ **Neo4j - Base de Dados de Grafos com Suporte Vetorial**
- **Performance Superior**: Busca vetorial e de grafos otimizada para an√°lise de amea√ßas
- **Escalabilidade**: Suporta milh√µes de n√≥s e relacionamentos de vulnerabilidades
- **Persist√™ncia Robusta**: Base de dados ACID com backup autom√°tico de dados de seguran√ßa
- **Flexibilidade**: Suporte a vetores, grafos e metadados complexos de threat modeling
- **Integra√ß√£o Nativa**: Compat√≠vel com LangChain e frameworks modernos de IA

### üíæ **Cache Inteligente com Neo4j para Dados de Seguran√ßa**
- Armazenamento persistente de embeddings de documentos de seguran√ßa no Neo4j
- Cache por documento com metadados flex√≠veis de threat modeling
- Estat√≠sticas detalhadas de uso de an√°lises de amea√ßas
- Limpeza seletiva de cache de dados de seguran√ßa
- Backup autom√°tico e recupera√ß√£o de dados cr√≠ticos

### üîç **Busca Sem√¢ntica Otimizada para An√°lise de Amea√ßas**
- Similaridade por cosseno implementada para documentos de seguran√ßa
- Filtros de qualidade de resultados de threat modeling
- Busca otimizada com √≠ndices vetoriais do Neo4j para vulnerabilidades
- Performance 10-100x superior ao sistema anterior de an√°lise de amea√ßas

## üß≠ Arquitetura do Z4l1nux AI Threat Lab

![RAG Architecture Model](docs/images/rag-architecture-model.jpg)

### Fluxo Principal do Sistema de An√°lise de Amea√ßas

```mermaid
flowchart TB
    %% User Interface
    UI[üåê Web Interface] --> API[üì° REST API]
    
    %% Core Processing
    API --> QP[üîç Question Processor]
    QP --> VS[üß† Vector Search]
    
    %% Database Layer
    VS --> NEO[(üóÇÔ∏è Neo4j<br/>Graph Database)]
    NEO --> EMB[üìä Embeddings<br/>nomic-embed-text]
    
    %% LLM Processing
    VS --> LLM{ü§ñ LLM Selection}
    LLM -->|Local| OLL[ü¶ô Ollama<br/>A sua escolha]
    LLM -->|Remote| OR[‚òÅÔ∏è OpenRouter<br/>A sua escolha]
    
    %% Document Processing
    DOC[üìÑ Security Document Upload] --> SEC[üîí Security Check]
    SEC --> PROC[‚öôÔ∏è Threat Document Processor]
    PROC --> NEO
    
    %% Response Generation
    OLL --> RG[üìù Threat Analysis Generator]
    OR --> RG
    RG --> TM[üéØ Threat Model Report]
    TM --> UI
    
    %% Styling
    classDef database fill:#e1f5fe
    classDef llm fill:#f3e5f5
    classDef security fill:#ffebee
    classDef processing fill:#e8f5e8
    
    class NEO database
    class OLL,OR,LLM llm
    class SEC security
    class QP,VS,PROC,RG processing
```

### Fluxo de Processamento

1. **Ingest√£o**: Documentos s√£o processados e divididos em chunks
2. **Embedding**: Cada chunk gera embedding vetorial
3. **Cache**: Embeddings s√£o armazenados no Neo4j
4. **Busca**: Consultas s√£o convertidas em embeddings e buscadas por similaridade
5. **Cache de Query**: Embeddings de consultas s√£o cacheados

## üöÄ Pr√©-requisitos

- Node.js (vers√£o 18 ou superior)
- npm ou yarn
- Ollama (para uso local)
- Docker (para Neo4j)

## üì¶ Instala√ß√£o

### **üöÄ Setup Autom√°tico (Recomendado)**

#### **Linux/macOS:**
```bash
./scripts/setup.sh
```

#### **Windows:**
```powershell
.\scripts\setup.ps1
```

### **üîß Setup Manual**

1. Instale as depend√™ncias do backend:
```bash
npm install
```

2. Instale as depend√™ncias do frontend:
```bash
cd src/client
npm install
cd ../..
```

3. Configure as vari√°veis de ambiente:
```bash
# Copie o arquivo de exemplo
cp .env.example .env

# Edite o arquivo .env com suas configura√ß√µes
nano .env
```

**Exemplo de configura√ß√£o (.env):**
```bash
# Configura√ß√µes do Ollama (para modelos locais)
OLLAMA_BASE_URL=http://127.0.0.1:11434
MODEL_OLLAMA=mistral
EMBEDDING_MODEL=nomic-embed-text:latest

# Configura√ß√µes do OpenRouter (para modelos remotos)
OPENROUTER_API_KEY=sua_chave_openrouter_aqui
MODEL_OPENROUTER=deepseek/deepseek-r1:free

# Configura√ß√µes do Neo4j
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=password

# Configura√ß√µes do servidor web
PORT=3000

# Configura√ß√µes de cache
RESPONSE_CACHE_TTL_MS=300000
RETRIEVAL_CACHE_TTL_MS=300000

# Modo de busca (neo4j)
SEARCH_MODE=neo4j
```

## ‚öôÔ∏è Configura√ß√£o do Ollama

1. Instale o Ollama seguindo as instru√ß√µes em: https://ollama.ai/

2. Baixe os modelos necess√°rios:
```bash
# Modelo de chat
ollama pull mistral

# Modelo de embeddings
ollama pull nomic-embed-text
```

3. Inicie o servidor Ollama:
```bash
ollama serve
```

## üóÑÔ∏è Configura√ß√£o do Neo4j (Opcional)

Para usar busca vetorial e de grafos, configure o Neo4j:

### Docker Compose (Recomendado)

O projeto j√° inclui um arquivo `docker-compose.yml` configurado. Execute:

```bash
docker-compose up -d
```

**Vers√µes dispon√≠veis:**
- **Est√°vel**: `neo4j:5.14.0-community` (padr√£o)
- **Mais recente**: `neo4j:5.26.12-community-ubi9` (altere no docker-compose.yml)

### Acessar Neo4j Browser

Ap√≥s iniciar o container, acesse:
- **Neo4j Browser**: http://localhost:7474
- **Usu√°rio**: neo4j
- **Senha**: password

### üìÅ Tipos de Arquivo de Seguran√ßa Suportados

O Z4l1nux AI Threat Lab suporta os seguintes tipos de arquivo para an√°lise de amea√ßas:

#### ‚úÖ Formatos de Documentos de Seguran√ßa Suportados
- **PDF**: Leitura e processamento completo de relat√≥rios de seguran√ßa via LangChain PDFLoader
- **XML**: Leitura e parsing de documentos de threat modeling via XMLLoader personalizado
- **JSON**: Leitura e parsing de dados de vulnerabilidades via JSONLoader personalizado  
- **CSV**: Leitura e parsing de listas de amea√ßas via CSVLoader personalizado
- **Markdown (.md/.markdown)**: Leitura de documenta√ß√£o de seguran√ßa via `MarkdownLoader`

#### üîß Como Funciona no Threat Lab
Cada tipo de arquivo de seguran√ßa √© processado por um loader espec√≠fico do LangChain:
- **PDF**: Usa o `PDFLoader` nativo para relat√≥rios de seguran√ßa
- **XML**: Converte XML de threat modeling para JSON estruturado
- **JSON**: Processa dados JSON de vulnerabilidades estruturados
- **CSV**: Converte linhas CSV de amea√ßas para objetos JSON

Todos os loaders seguem o padr√£o LangChain e retornam documentos de seguran√ßa com metadados apropriados para an√°lise de amea√ßas.

## üéØ Uso

### **üöÄ Execu√ß√£o em Desenvolvimento**

#### **Linux/macOS:**
```bash
./scripts/dev.sh
```

#### **Windows:**
```powershell
.\scripts\dev.ps1
```

#### **Manual:**
```bash
# Executar aplica√ß√£o completa
npm run dev
```

### **üåê Acesso √† Aplica√ß√£o**

#### **Em Desenvolvimento:**
- **Aplica√ß√£o:** http://localhost:3000 (backend serve o React)
- **Frontend Dev:** http://localhost:3001 (Vite - hot reload)
- **Backend API:** http://localhost:3000/api

#### **Em Produ√ß√£o:**
- **Aplica√ß√£o:** http://localhost:3000 (backend serve o build)
- **Backend API:** http://localhost:3000/api

**Nota:** Em desenvolvimento, use `http://localhost:3000` para acessar a aplica√ß√£o. O Vite dev server (3001) √© usado internamente para hot reload.

### **üß™ Testes e Verifica√ß√£o do Threat Lab**

Para testar os loaders de documentos de seguran√ßa e funcionalidades de an√°lise de amea√ßas:

```bash
# Testar os loaders de XML, JSON e CSV para documentos de seguran√ßa
npm run test-loaders

# Testar o sistema RAG completo para an√°lise de amea√ßas
npm run test-rag

# Testar especificamente o Neo4j para threat modeling
npm run test-neo4j
```

### Gerenciador de Cache Interativo do Threat Lab

Execute o gerenciador de cache Neo4j para an√°lise de amea√ßas:
```bash
npm run create-neo4j
```

**Op√ß√µes dispon√≠veis para an√°lise de seguran√ßa:**

1. **üîÑ Atualiza√ß√£o Incremental (Recomendado)**
   - Detecta automaticamente mudan√ßas nos documentos de threat modeling
   - Processa apenas documentos de seguran√ßa novos/modificados
   - Mais r√°pido e eficiente para an√°lise de amea√ßas

2. **üîÑ Reprocessamento Completo**
   - Reprocessa todos os documentos de seguran√ßa
   - √ötil para mudan√ßas de configura√ß√£o de an√°lise
   - Mais lento, mas garante consist√™ncia dos dados de amea√ßas

3. **üìä Mostrar Estat√≠sticas de Seguran√ßa**
   - Exibe informa√ß√µes detalhadas do cache de dados de seguran√ßa
   - Total de documentos de threat modeling e chunks
   - Tamanho do cache e datas de an√°lise

4. **üóëÔ∏è Limpar Cache de Seguran√ßa**
   - Remove completamente o cache de dados de amea√ßas
   - √ötil para resetar o sistema de an√°lise

### Interface Web do Threat Lab (Recomendado)

1. **Iniciar o servidor web do Threat Lab:**
```bash
npm run web
```

2. **Abrir no navegador:**
```
http://localhost:3000
```

3. **Usar a interface web para an√°lise de amea√ßas:**
   - Escolha entre Ollama (local) ou DeepSeek (OpenRouter)
   - Digite sua pergunta sobre threat modeling ou vulnerabilidades
   - Veja a resposta de an√°lise de amea√ßas e logs em tempo real
   - Visualize estat√≠sticas dos resultados de seguran√ßa

### Interface de Linha de Comando do Threat Lab

1. **Executar o programa de an√°lise de amea√ßas:**
```bash
npm run dev
```

2. **Escolher o modelo para an√°lise de threat modeling:**
   - **1 - Ollama (Local)**: Usa o modelo Mistral local via Ollama para an√°lise de seguran√ßa
   - **2 - DeepSeek (OpenRouter)**: Usa o modelo DeepSeek via OpenRouter para threat modeling

## üèóÔ∏è Arquitetura do Z4l1nux AI Threat Lab

### Estrutura de Diret√≥rios

```
threat-model/
‚îú‚îÄ‚îÄ src/                    # üìÅ C√≥digo fonte principal
‚îÇ   ‚îú‚îÄ‚îÄ core/              # üß† L√≥gica principal do sistema de an√°lise de amea√ßas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache/         # üíæ Gerenciadores de cache de dados de seguran√ßa
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Neo4jCacheManager.ts      # Cache Neo4j para threat modeling
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search/        # üîç Implementa√ß√µes de busca sem√¢ntica
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Neo4jOnlySearchFactory.ts # Factory para busca Neo4j
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Neo4jSemanticSearch.ts    # Busca Neo4j para an√°lise de amea√ßas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ graph/         # üï∏Ô∏è Integra√ß√£o com Neo4j para grafos de amea√ßas
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Neo4jClient.ts            # Cliente Neo4j para dados de seguran√ßa
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Neo4jSyncService.ts       # Sincroniza√ß√£o com grafos de vulnerabilidades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts       # üìù Tipos principais do sistema de threat modeling
‚îÇ   ‚îú‚îÄ‚îÄ cli/               # üíª Interfaces de linha de comando
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.ts        # Interface principal CLI do Threat Lab
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reprocessNonInteractive.ts   # Reprocessamento autom√°tico de amea√ßas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ managers/      # üõ†Ô∏è Gerenciadores espec√≠ficos de an√°lise
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ buscaNeo4j.ts            # Busca Neo4j para threat modeling
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ criarNeo4j.ts            # Gerenciador Neo4j para dados de seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ web/               # üåê Interface web do Threat Lab
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.ts      # Servidor web Express para an√°lise de amea√ßas
‚îÇ   ‚îú‚îÄ‚îÄ utils/             # üîß Utilit√°rios gerais do sistema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fileUtils.ts   # Utilit√°rios para arquivos de seguran√ßa
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documentLoaders.ts  # Loaders para diferentes formatos de documentos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProgressTracker.ts  # Rastreador de progresso de an√°lises
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PromptTemplates.ts  # Templates de prompts para threat modeling
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SecureDocumentProcessor.ts   # Processador seguro de documentos
‚îÇ   ‚îî‚îÄ‚îÄ test/              # üß™ Testes do sistema de an√°lise de amea√ßas
‚îÇ       ‚îú‚îÄ‚îÄ testCAPECSearch.ts           # Testes de busca CAPEC
‚îÇ       ‚îú‚îÄ‚îÄ testFormattedResponse.ts     # Testes de resposta formatada
‚îÇ       ‚îú‚îÄ‚îÄ testLoaders.ts               # Testes dos loaders de documentos
‚îÇ       ‚îú‚îÄ‚îÄ testPerformance.ts           # Testes de performance do sistema
‚îÇ       ‚îî‚îÄ‚îÄ testRAG.ts                   # Testes do sistema RAG completo
‚îú‚îÄ‚îÄ dist/                  # üì¶ Arquivos compilados (TypeScript ‚Üí JavaScript)
‚îú‚îÄ‚îÄ docs/                  # üìö Documenta√ß√£o do Threat Lab
‚îÇ   ‚îî‚îÄ‚îÄ images/            # üñºÔ∏è Imagens e diagramas de arquitetura
‚îú‚îÄ‚îÄ public/                # üåê Arquivos p√∫blicos da interface web
‚îú‚îÄ‚îÄ docker-compose.yml     # üê≥ Configura√ß√£o Docker para Neo4j
‚îú‚îÄ‚îÄ package.json           # üìã Depend√™ncias e scripts do projeto
‚îú‚îÄ‚îÄ tsconfig.json          # ‚öôÔ∏è Configura√ß√£o TypeScript
‚îî‚îÄ‚îÄ README.md              # üìñ Documenta√ß√£o principal do Z4l1nux AI Threat Lab
```

### Princ√≠pios de Organiza√ß√£o do Threat Lab

- **Separa√ß√£o de Responsabilidades**: Cada diret√≥rio tem uma fun√ß√£o espec√≠fica no sistema de an√°lise de amea√ßas
- **Padr√£o de Nomenclatura**: PascalCase para classes de threat modeling, camelCase para fun√ß√µes de an√°lise
- **Organiza√ß√£o por Funcionalidade**: Arquivos relacionados √† seguran√ßa ficam pr√≥ximos
- **Imports Organizados**: Relativos claros e intuitivos para componentes de an√°lise de amea√ßas
- **Modularidade de Seguran√ßa**: Componentes independentes para diferentes tipos de an√°lise de vulnerabilidades

## üîß Configura√ß√µes Avan√ßadas

### Par√¢metros de Chunking
```typescript
{
  chunkSize: 2000,        // Tamanho do chunk em caracteres
  chunkOverlap: 500,      // Sobreposi√ß√£o entre chunks
  modelEmbedding: "nomic-embed-text:latest"  // Modelo de embedding
}
```

### Filtros de Busca
```typescript
// Similaridade m√≠nima para resultados
scoreThreshold: 0.1

// N√∫mero m√°ximo de resultados
maxResults: 8
```

### Modos de Busca
- **`neo4j`**: Busca vetorial e de grafos (recomendado)

## üöÄ Comandos Dispon√≠veis

### Desenvolvimento
```bash
# Interface CLI
npm run dev

# Aplica√ß√£o Web (React + TypeScript)
# Acesse: http://localhost:3000 (backend serve o React)

# Build de produ√ß√£o
npm run build

# Ou usar scripts automatizados
./scripts/build.sh        # Linux/macOS
.\scripts\build.ps1       # Windows
```

### Gerenciamento de Cache
```bash
# Cache Neo4j (recomendado)
npm run create-neo4j

# Reprocessamento autom√°tico
npm run reprocess-neo4j

# Sincroniza√ß√£o com Neo4j
npm run sync-neo4j
```

### Busca Especializada
```bash
# Busca Neo4j
npm run search-neo4j
```

### Testes
```bash
# Testes espec√≠ficos
npm run test-neo4j
npm run test-rag
npm run test-loaders
npm run test-performance
npm run test-capec
npm run test-formatted
```

### Vantagens do Sistema:

- **Performance**: 10-100x mais r√°pido na busca
- **Escalabilidade**: Suporte a milh√µes de documentos
- **Confiabilidade**: Backup autom√°tico e recupera√ß√£o
- **Flexibilidade**: Metadados mais ricos e consultas avan√ßadas
- **Busca Neo4j**: Combina busca vetorial com grafos de conhecimento

## üêõ Solu√ß√£o de Problemas

### Erro: "OPENROUTER_API_KEY √© obrigat√≥ria"
```bash
# Copie o arquivo de exemplo e configure
cp .env.example .env
# Edite o arquivo .env e adicione sua chave OpenRouter
```

### Erro: "Banco de dados Neo4j n√£o encontrado"
```bash
# Execute o gerenciador de cache Neo4j
npm run create-neo4j
```

### Erro: "Ollama n√£o est√° rodando"
```bash
# Inicie o servidor Ollama
ollama serve

# Verifique se os modelos est√£o instalados
ollama list

# Se necess√°rio, baixe os modelos
ollama pull mistral
ollama pull nomic-embed-text
```

## ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch para sua feature
3. Commit suas mudan√ßas
4. Push para a branch
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° licenciado sob a Licen√ßa MIT - veja o arquivo [LICENSE](LICENSE) para detalhes. 