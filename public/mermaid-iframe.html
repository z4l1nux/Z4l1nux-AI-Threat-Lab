<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Árvore de Ataque - Threat Modeling</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js" integrity="sha512-HvxxeyPSnbU7/x0g15v3OMxTFeADyCUnCN3iCam3BDTxgFPKxa+ujRCbFuwjE8PASDwOH5LpzFfGGNWks7tuJQ==" crossorigin="anonymous"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
      color: #e8eaed;
    }

    #inputView {
      padding: 1rem;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    textarea {
      width: 100%;
      min-width: 80vw;
      height: 300px;
      font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      color: #e8eaed;
      padding: 12px;
    }

    textarea:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 16px;
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
    }

    #diagram {
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
    }

    #diagram svg {
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease;
      cursor: grab;
    }

    #diagram svg:active {
      cursor: grabbing;
    }

    /* Controles de zoom - Estilo Threat Modeling */
    .zoom-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(255, 107, 53, 0.3);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      z-index: 1000;
    }

    .zoom-controls button {
      margin: 0 4px 4px 0;
      padding: 10px 14px;
      border: 1px solid rgba(255, 107, 53, 0.3);
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.8);
      color: #e8eaed;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      min-width: 45px;
    }

    .zoom-controls button:hover {
      background: rgba(255, 107, 53, 0.2);
      border-color: #ff6b35;
      transform: none;
      box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
    }

    .zoom-controls button:active {
      background: rgba(255, 107, 53, 0.3);
    }

    /* Botões de exportar - Estilo Threat Modeling */
    .export-controls {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(255, 107, 53, 0.3);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      z-index: 1000;
    }

    .export-controls button {
      margin: 0 4px 4px 0;
      padding: 10px 14px;
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(16, 185, 129, 0.8));
      color: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .export-controls button:hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 1), rgba(16, 185, 129, 1));
      transform: none;
      box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4);
    }

    /* Indicador de zoom - Estilo Threat Modeling */
    .zoom-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #ff6b35;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      z-index: 1000;
      border: 1px solid rgba(255, 107, 53, 0.3);
      backdrop-filter: blur(5px);
    }

    /* Tooltips melhorados */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 140px;
      background-color: rgba(0, 0, 0, 0.9);
      color: #e8eaed;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1001;
      bottom: 125%;
      left: 50%;
      margin-left: -70px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      border: 1px solid rgba(255, 107, 53, 0.3);
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Info header para modo editor */
    .info-header {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(30, 41, 59, 0.95);
      border: 2px solid #ff6b35;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
      max-width: 400px;
    }

    .info-header h2 {
      color: #ff6b35;
      margin-bottom: 10px;
      font-size: 1.4rem;
    }

    .info-header p {
      color: #94a3b8;
      margin-bottom: 15px;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .zoom-controls, .export-controls {
        padding: 8px;
        top: 10px;
      }
      
      .zoom-controls {
        right: 10px;
      }
      
      .export-controls {
        left: 10px;
      }
      
      .zoom-controls button, .export-controls button {
        padding: 8px 10px;
        font-size: 12px;
        margin: 0 2px 2px 0;
      }
      
      .zoom-indicator {
        bottom: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="inputView" style="display: none;">
    <div class="info-header">
      <h2>🔐 Editor de Árvore de Ataque</h2>
      <p>Edite o código Mermaid da árvore de ataque e veja o resultado em tempo real.</p>
    </div>
    <textarea id="diagramInput" placeholder="Digite o código Mermaid da árvore de ataque aqui..."></textarea><br/>
    <button onclick="generateDiagram()">🚀 Gerar Diagrama</button>
  </div>

  <div id="diagram"></div>

  <!-- Controles de zoom -->
  <div class="zoom-controls">
    <div class="tooltip">
      <button onclick="zoomIn()" title="Aumentar Zoom">🔍+</button>
      <span class="tooltiptext">Aumentar zoom</span>
    </div>
    <div class="tooltip">
      <button onclick="zoomOut()" title="Diminuir Zoom">🔍-</button>
      <span class="tooltiptext">Diminuir zoom</span>
    </div>
    <div class="tooltip">
      <button onclick="resetZoom()" title="Resetar Zoom">🔄</button>
      <span class="tooltiptext">Resetar zoom</span>
    </div>
    <div class="tooltip">
      <button onclick="fitToScreen()" title="Ajustar à Tela">📐</button>
      <span class="tooltiptext">Ajustar à tela</span>
    </div>
  </div>

  <!-- Botões de exportar -->
  <div class="export-controls">
    <div class="tooltip">
      <button onclick="exportPNG()" title="Exportar PNG">📷 PNG</button>
      <span class="tooltiptext">Exportar como PNG</span>
    </div>
    <div class="tooltip">
      <button onclick="exportSVG()" title="Exportar SVG">🎨 SVG</button>
      <span class="tooltiptext">Exportar como SVG</span>
    </div>
    <div class="tooltip">
      <button onclick="editMode()" title="Editar Código">✏️ Editar</button>
      <span class="tooltiptext">Editar código Mermaid</span>
    </div>
  </div>

  <!-- Indicador de zoom -->
  <div class="zoom-indicator" id="zoomIndicator">100%</div>

  <script>
    mermaid.initialize({ 
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#ff6b35',
        primaryTextColor: '#e8eaed',
        primaryBorderColor: '#ff6b35',
        lineColor: '#94a3b8',
        sectionBkgColor: 'rgba(30, 41, 59, 0.8)',
        altSectionBkgColor: 'rgba(15, 23, 42, 0.8)',
        gridColor: 'rgba(148, 163, 184, 0.2)',
        tertiaryColor: 'rgba(59, 130, 246, 0.2)',
        background: '#0f1419',
        secondaryColor: '#1a2332',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis',
        nodeSpacing: 80,
        rankSpacing: 80,
        padding: 30,
        wrap: true,
        diagramPadding: 20
      },
      securityLevel: 'loose'
    });

    let currentZoom = 1;
    let currentTransform = { x: 0, y: 0 };
    let isDragging = false;
    let lastMousePos = { x: 0, y: 0 };

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function generateDiagram() {
      const text = document.getElementById("diagramInput").value;
      const encoded = btoa(encodeURIComponent(text));
      const newUrl = `${window.location.origin}${window.location.pathname}?diagram=${encoded}`;
      window.location.href = newUrl;
    }

    function editMode() {
      const currentDiagram = getQueryParam("diagram");
      if (currentDiagram) {
        const editUrl = `${window.location.origin}${window.location.pathname}?diagram=${currentDiagram}&edit=true`;
        window.location.href = editUrl;
      } else {
        document.getElementById("inputView").style.display = "block";
      }
    }

    function updateZoomIndicator() {
      document.getElementById('zoomIndicator').textContent = `${Math.round(currentZoom * 100)}%`;
    }

    function applyTransform() {
      const svg = document.querySelector('#diagram svg');
      if (svg) {
        svg.style.transform = `translate(${currentTransform.x}px, ${currentTransform.y}px) scale(${currentZoom})`;
        updateZoomIndicator();
      }
    }

    function zoomIn() {
      currentZoom = Math.min(currentZoom * 1.2, 5);
      applyTransform();
    }

    function zoomOut() {
      currentZoom = Math.max(currentZoom / 1.2, 0.1);
      applyTransform();
    }

    function resetZoom() {
      currentZoom = 1;
      currentTransform = { x: 0, y: 0 };
      applyTransform();
    }

    function fitToScreen() {
      const svg = document.querySelector('#diagram svg');
      if (svg) {
        // Resetar transformações primeiro
        svg.style.transform = 'none';
        
        const svgRect = svg.getBoundingClientRect();
        const containerRect = document.getElementById('diagram').getBoundingClientRect();
        
        const scaleX = containerRect.width / svgRect.width;
        const scaleY = containerRect.height / svgRect.height;
        currentZoom = Math.min(scaleX, scaleY, 1) * 0.85; // 85% para margem
        
        currentTransform = { x: 0, y: 0 };
        applyTransform();
      }
    }

    function exportPNG() {
      const svg = document.querySelector('#diagram svg');
      if (!svg) {
        alert('❌ Nenhum diagrama encontrado para exportar.');
        return;
      }

      try {
        // Criar uma cópia do SVG para exportação
        const svgClone = svg.cloneNode(true);
        
        // Remover transformações de zoom/pan do clone
        svgClone.style.transform = 'none';
        
        // Obter as dimensões reais do SVG
        const svgRect = svg.getBoundingClientRect();
        const viewBox = svg.viewBox.baseVal;
        
        // Calcular dimensões para exportação com alta resolução
        const scale = 3; // Aumentar resolução 3x para melhor qualidade
        const exportWidth = Math.max(svgRect.width * scale, 2400); // Mínimo de 2400px
        const exportHeight = Math.max(svgRect.height * scale, 1600); // Mínimo de 1600px
        
        // Configurar viewBox para incluir todo o conteúdo
        if (viewBox && viewBox.width > 0 && viewBox.height > 0) {
          svgClone.setAttribute('viewBox', `0 0 ${viewBox.width} ${viewBox.height}`);
        }
        svgClone.setAttribute('width', exportWidth);
        svgClone.setAttribute('height', exportHeight);
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
          canvas.width = exportWidth;
          canvas.height = exportHeight;
          
          // Configurar contexto para alta qualidade
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          
          // Preencher fundo com cor do tema dark
          ctx.fillStyle = '#0f1419'; // Cor de fundo do sistema
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // Desenhar o SVG com alta qualidade
          ctx.drawImage(img, 0, 0, exportWidth, exportHeight);
          
          const link = document.createElement('a');
          link.download = `arvore-ataque-${new Date().toISOString().split('T')[0]}.png`;
          link.href = canvas.toDataURL('image/png', 1.0);
          link.click();
        };
        
        img.onerror = function() {
          alert('❌ Erro ao gerar imagem PNG. Tente o formato SVG.');
        };
        
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        
      } catch (error) {
        console.error('Erro ao exportar PNG:', error);
        alert('❌ Erro ao exportar PNG. Verifique o console para detalhes.');
      }
    }

    function exportSVG() {
      const svg = document.querySelector('#diagram svg');
      if (!svg) {
        alert('❌ Nenhum diagrama encontrado para exportar.');
        return;
      }

      try {
        // Criar uma cópia do SVG para exportação
        const svgClone = svg.cloneNode(true);
        
        // Remover transformações de zoom/pan do clone
        svgClone.style.transform = 'none';
        
        // Obter as dimensões reais do SVG
        const svgRect = svg.getBoundingClientRect();
        const viewBox = svg.viewBox.baseVal;
        
        // Calcular dimensões para exportação
        const exportWidth = Math.max(svgRect.width, 1200);
        const exportHeight = Math.max(svgRect.height, 800);
        
        // Configurar viewBox para incluir todo o conteúdo
        if (viewBox && viewBox.width > 0 && viewBox.height > 0) {
          svgClone.setAttribute('viewBox', `0 0 ${viewBox.width} ${viewBox.height}`);
        }
        svgClone.setAttribute('width', exportWidth);
        svgClone.setAttribute('height', exportHeight);
        
        // Adicionar metadados
        const metadata = document.createElement('metadata');
        metadata.innerHTML = `
          <title>Árvore de Ataque - ${new Date().toLocaleDateString('pt-BR')}</title>
          <description>Diagrama de árvore de ataque gerado pelo sistema de modelagem de ameaças</description>
        `;
        svgClone.insertBefore(metadata, svgClone.firstChild);
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.download = `arvore-ataque-${new Date().toISOString().split('T')[0]}.svg`;
        link.href = url;
        link.click();
        
        URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('Erro ao exportar SVG:', error);
        alert('❌ Erro ao exportar SVG. Verifique o console para detalhes.');
      }
    }

    // Controles de mouse para pan
    function setupMouseControls() {
      const diagram = document.getElementById('diagram');
      
      diagram.addEventListener('mousedown', (e) => {
        if (e.button === 0) { // Botão esquerdo
          isDragging = true;
          lastMousePos = { x: e.clientX, y: e.clientY };
          diagram.style.cursor = 'grabbing';
        }
      });
      
      diagram.addEventListener('mousemove', (e) => {
        if (isDragging) {
          const deltaX = e.clientX - lastMousePos.x;
          const deltaY = e.clientY - lastMousePos.y;
          
          currentTransform.x += deltaX;
          currentTransform.y += deltaY;
          
          lastMousePos = { x: e.clientX, y: e.clientY };
          applyTransform();
        }
      });
      
      diagram.addEventListener('mouseup', () => {
        isDragging = false;
        diagram.style.cursor = 'grab';
      });
      
      diagram.addEventListener('mouseleave', () => {
        isDragging = false;
        diagram.style.cursor = 'grab';
      });
      
      // Zoom com scroll
      diagram.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        currentZoom = Math.max(0.1, Math.min(5, currentZoom * delta));
        applyTransform();
      });
      
      // Configurar cursor inicial
      diagram.style.cursor = 'grab';
    }

    async function renderDiagram(text) {
      const diagramDiv = document.getElementById("diagram");
      try {
        const { svg } = await mermaid.render('theGraph', text);
        diagramDiv.innerHTML = svg;
        
        // Ajustar viewBox para incluir todo o conteúdo
        setTimeout(() => {
          const svgElement = document.querySelector('#diagram svg');
          if (svgElement) {
            adjustSVGViewBox(svgElement);
          }
        }, 100);
        
        // Configurar controles de mouse após renderizar
        setupMouseControls();
        
        // Ajustar automaticamente ao tamanho da tela
        setTimeout(fitToScreen, 200);
      } catch (e) {
        console.error('Erro ao renderizar diagrama:', e);
        diagramDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ff6b35;">
            <h3>❌ Erro ao Renderizar Diagrama</h3>
            <p style="color: #94a3b8; margin: 10px 0;">${e.message}</p>
            <button onclick="editMode()" style="margin-top: 15px;">✏️ Editar Código</button>
          </div>
        `;
      }
    }

    function adjustSVGViewBox(svgElement) {
      try {
        // Obter todos os elementos dentro do SVG
        const elements = svgElement.querySelectorAll('*');
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        elements.forEach(element => {
          try {
            const bbox = element.getBBox();
            if (bbox.width > 0 && bbox.height > 0) {
              minX = Math.min(minX, bbox.x);
              minY = Math.min(minY, bbox.y);
              maxX = Math.max(maxX, bbox.x + bbox.width);
              maxY = Math.max(maxY, bbox.y + bbox.height);
            }
          } catch (e) {
            // Ignorar elementos que não suportam getBBox()
          }
        });
        
        // Adicionar margem de 30px
        const margin = 30;
        minX -= margin;
        minY -= margin;
        maxX += margin;
        maxY += margin;
        
        // Definir viewBox se valores são válidos
        if (isFinite(minX) && isFinite(minY) && isFinite(maxX) && isFinite(maxY)) {
          const width = maxX - minX;
          const height = maxY - minY;
          svgElement.setAttribute('viewBox', `${minX} ${minY} ${width} ${height}`);
        }
      } catch (error) {
        console.warn('Não foi possível ajustar viewBox:', error);
      }
    }

    // Configuração inicial
    const diagramInput = document.getElementById("diagramInput");
    const inputView = document.getElementById("inputView");
    const diagramDiv = document.getElementById("diagram");

    function onDiagramInputChange() {
      const text = diagramInput.value.trim();
      if (text) {
        renderDiagram(text);
      }
    }

    if (diagramInput) {
      diagramInput.addEventListener("input", onDiagramInputChange);
    }

    // Processar parâmetros da URL
    const base64Diagram = getQueryParam("diagram");
    const editMode = getQueryParam("edit") === "true";

    if (base64Diagram) {
      try {
        const decoded = decodeURIComponent(atob(base64Diagram));
        if (editMode) {
          diagramInput.value = decoded;
          inputView.style.display = "block";
          diagramDiv.style.display = "block";
          renderDiagram(decoded);
        } else {
          renderDiagram(decoded);
          inputView.style.display = "none";
        }
      } catch (err) {
        console.error('Erro ao decodificar diagrama:', err);
        document.getElementById("diagram").innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ff6b35;">
            <h3>❌ Erro ao Decodificar Diagrama</h3>
            <p style="color: #94a3b8;">O link pode estar corrompido ou inválido.</p>
            <button onclick="editMode()">✏️ Criar Novo Diagrama</button>
          </div>
        `;
      }
    } else {
      inputView.style.display = "block";
      diagramDiv.style.display = "block";
      
      // Diagrama de exemplo se não houver parâmetros
      document.getElementById("diagram").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
          <h2 style="color: #ff6b35; margin-bottom: 15px;">🔐 Visualizador de Árvore de Ataque</h2>
          <p>Nenhum diagrama carregado. Use os controles para navegar ou criar um novo diagrama.</p>
          <button onclick="editMode()" style="margin-top: 15px;">✏️ Criar Diagrama</button>
        </div>
      `;
    }

    // Atalhos de teclado
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case '=':
          case '+':
            e.preventDefault();
            zoomIn();
            break;
          case '-':
            e.preventDefault();
            zoomOut();
            break;
          case '0':
            e.preventDefault();
            resetZoom();
            break;
        }
      }
    });
  </script>
</body>
</html>
