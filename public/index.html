<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z4l1nux AI Threat Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="threat-modeling.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%); color: #e8eaed; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; background: linear-gradient(135deg, #ff6b35, #f7931e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.8; color: #94a3b8; }
        .input-section { background: rgba(30, 41, 59, 0.6); border-radius: 16px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #f1f5f9; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid rgba(148, 163, 184, 0.2); background: rgba(15, 23, 42, 0.8); color: #e8eaed; font-size: 14px; transition: all 0.3s ease; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: #ff6b35; box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1); }
        .input-group textarea { min-height: 120px; resize: vertical; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .generate-btn { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 15px 30px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: block; margin: 0 auto; min-width: 200px; }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .results-section { margin-top: 40px; }
        .report-card { background: rgba(30, 41, 59, 0.6); border-radius: 16px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
        .report-title { color: #ff6b35; font-size: 1.5rem; font-weight: 600; }
        .export-btn { background: rgba(34, 197, 94, 0.8); color: white; padding: 8px 16px; border-radius: 8px; border: none; font-size: 14px; cursor: pointer; transition: all 0.3s ease; }
        .export-btn:hover { background: rgba(34, 197, 94, 1); }
        .attack-tree { background: rgba(15, 23, 42, 0.8); border-radius: 12px; padding: 20px; margin: 20px 0; }
        .threat-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(15, 23, 42, 0.8); border-radius: 12px; overflow: hidden; }
        .threat-table th { background: rgba(255, 107, 53, 0.2); padding: 15px 12px; text-align: left; font-weight: 600; color: #ff6b35; font-size: 14px; }
        .threat-table td { padding: 15px 12px; border-bottom: 1px solid rgba(148, 163, 184, 0.1); vertical-align: top; font-size: 13px; line-height: 1.4; }
        .threat-table tr:hover { background: rgba(255, 107, 53, 0.05); }
        .severity-critical { background: rgba(220, 38, 38, 0.2); color: #fca5a5; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .severity-high { background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .severity-medium { background: rgba(245, 158, 11, 0.2); color: #fcd34d; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .severity-low { background: rgba(34, 197, 94, 0.2); color: #86efac; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .stride-tag { background: rgba(59, 130, 246, 0.2); color: #93c5fd; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-right: 4px; display: inline-block; margin-bottom: 2px; }
        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255, 107, 53, 0.3); border-radius: 50%; border-top-color: #ff6b35; animation: spin 1s ease-in-out infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: rgba(15, 23, 42, 0.8); padding: 20px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #ff6b35; margin-bottom: 5px; }
        .stat-label { color: #94a3b8; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Z4l1nux AI Threat Lab</h1>
            <p>An√°lise Inteligente de Amea√ßas de Seguran√ßa com IA</p>
        </div>

            <div class="input-section">
            <div class="input-grid">
            <div class="input-group">
                <label for="systemName">Nome do Sistema</label>
                    <input type="text" id="systemName" placeholder="Ex: Sistema de E-commerce">
                </div>
                <div class="input-group">
                    <label for="systemType">Tipo de Sistema</label>
                    <select id="systemType">
                        <option value="web">Aplica√ß√£o Web</option>
                        <option value="api">API/Servi√ßo</option>
                        <option value="mobile">Aplicativo Mobile</option>
                        <option value="desktop">Aplica√ß√£o Desktop</option>
                        <option value="iot">Dispositivo IoT</option>
                        <option value="cloud">Sistema Cloud</option>
                    </select>
                </div>
                </div>

            <div class="input-grid">
                <div class="input-group">
                    <label for="sensitivity">N√≠vel de Sensibilidade</label>
                    <select id="sensitivity">
                        <option value="baixa">Baixa</option>
                        <option value="media">M√©dia</option>
                        <option value="alta">Alta</option>
                        <option value="critica">Cr√≠tica</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="aiModel">Modelo de IA</label>
                    <select id="aiModel">
                        <option value="">üîÑ Carregando modelos...</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label for="systemDescription">Descri√ß√£o do Sistema</label>
                <textarea id="systemDescription" placeholder="Descreva o sistema, suas funcionalidades, tecnologias utilizadas, arquitetura, etc."></textarea>
            </div>

            <div class="input-group">
                <label for="assets">Ativos Principais</label>
                <textarea id="assets" placeholder="Liste os ativos principais do sistema (dados, funcionalidades, recursos, etc.)"></textarea>
            </div>
            
            <div class="input-group">
                <label for="documents">üìÑ Documentos de Refer√™ncia (Opcional)</label>
                <input type="file" id="documents" multiple accept=".pdf,.txt,.md,.doc,.docx" style="padding: 8px; border: 2px solid rgba(148, 163, 184, 0.2); border-radius: 8px; background: rgba(15, 23, 42, 0.8); color: #e8eaed;">
                <small style="color: #94a3b8; font-size: 12px; margin-top: 5px; display: block;">
                    Fa√ßa upload de documentos t√©cnicos, especifica√ß√µes, arquitetura ou outros materiais relevantes para enriquecer a an√°lise de amea√ßas.
                </small>
                <button type="button" onclick="processDocuments()" style="background: rgba(59, 130, 246, 0.8); color: white; padding: 8px 16px; border-radius: 8px; border: none; font-size: 14px; cursor: pointer; transition: all 0.3s ease; margin-top: 10px;">
                    üìÑ Processar Documentos
                </button>
            </div>

            <button class="generate-btn" onclick="generateThreatModel()">üîç Gerar An√°lise de Amea√ßas</button>
        </div>
        
        <div id="results" class="results-section" style="display: none;"></div>
    </div>

    <script>
        // Inicializar Mermaid
        mermaid.initialize({
            theme: 'dark',
            themeVariables: {
                primaryColor: '#ff6b35',
                primaryTextColor: '#e8eaed',
                primaryBorderColor: '#ff6b35',
                lineColor: '#94a3b8',
                secondaryColor: '#1e293b',
                tertiaryColor: '#0f1419',
                background: '#0f1419',
                mainBkg: '#1e293b',
                secondBkg: '#334155',
                tertiaryBkg: '#475569',
                nodeBkg: '#1e293b',
                nodeBorder: '#ff6b35',
                clusterBkg: '#334155',
                clusterBorder: '#475569',
                defaultLinkColor: '#94a3b8',
                titleColor: '#ff6b35',
                edgeLabelBackground: '#1e293b',
                edgeLabelColor: '#e8eaed',
                gridColor: 'rgba(148, 163, 184, 0.2)',
                tertiaryColor: 'rgba(59, 130, 246, 0.2)'
            }
        });

        // Carregar modelos dispon√≠veis quando a p√°gina carregar
        async function loadAvailableModels() {
            try {
                console.log('üîÑ Carregando modelos dispon√≠veis...');
                const response = await fetch('/api/models');
                const models = await response.json();
                
                const aiModelSelect = document.getElementById('aiModel');
                aiModelSelect.innerHTML = '';
                
                if (models.chat && models.chat.length > 0) {
                    models.chat.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.value;
                        option.textContent = model.name;
                        option.disabled = !model.enabled;
                        
                        if (model.recommended) {
                            option.selected = true;
                        }
                        
                        aiModelSelect.appendChild(option);
                    });
                    console.log('‚úÖ Modelos carregados:', models.chat.length);
                } else {
                    // Fallback se n√£o houver modelos configurados
                    aiModelSelect.innerHTML = `
                        <option value="1">ü¶ô Ollama (Local)</option>
                        <option value="2">üß† DeepSeek (OpenRouter)</option>
                    `;
                    console.log('‚ö†Ô∏è Usando modelos fallback');
                }
                
                console.log('üîß Embedding:', models.embedding.model, '(' + models.embedding.provider + ')');
            } catch (error) {
                console.error('‚ùå Erro ao carregar modelos:', error);
                // Fallback em caso de erro
                const aiModelSelect = document.getElementById('aiModel');
                aiModelSelect.innerHTML = `
                    <option value="1">ü¶ô Ollama (Local)</option>
                    <option value="2">üß† DeepSeek (OpenRouter)</option>
                `;
            }
        }

        // Carregar modelos quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', loadAvailableModels);

        async function processDocuments() {
            const documentsInput = document.getElementById('documents');
            
            if (!documentsInput.files || documentsInput.files.length === 0) {
                alert('Por favor, selecione pelo menos um documento para processar.');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading">üìÑ Processando documentos...</div>';

            try {
                const formData = new FormData();
                for (let i = 0; i < documentsInput.files.length; i++) {
                    formData.append('documents', documentsInput.files[i]);
                }

                const uploadResponse = await fetch('/api/upload-documents', {
                    method: 'POST',
                    body: formData
                });

                const uploadResult = await uploadResponse.json();
                console.log('üìÑ Resultado do processamento:', uploadResult);

                if (uploadResult.success) {
                    resultsDiv.innerHTML = `
                        <div class="report-card">
                            <div class="report-header">
                                <h2 class="report-title">‚úÖ Documentos Processados com Sucesso</h2>
                            </div>
                            <div style="padding: 20px;">
                                <p><strong>Arquivos processados:</strong> ${uploadResult.summary.filesProcessed}</p>
                                <p><strong>Arquivos rejeitados:</strong> ${uploadResult.summary.filesRejected}</p>
                                <p><strong>Total de arquivos:</strong> ${uploadResult.summary.filesUploaded}</p>
                                <p><strong>Verifica√ß√µes de seguran√ßa:</strong> ${uploadResult.summary.securityChecks}</p>
                                
                                <h3 style="margin-top: 20px; color: #ff6b35;">üìã Logs do Processamento:</h3>
                                <div style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; margin-top: 10px;">
                                    ${uploadResult.logs.map(log => `<div style="margin: 5px 0; font-family: monospace; font-size: 12px;">${log}</div>`).join('')}
                                </div>
                                
                                <p style="margin-top: 20px; color: #94a3b8;">
                                    Os documentos foram processados e adicionados √† base de conhecimento. 
                                    Agora voc√™ pode gerar a an√°lise de amea√ßas com informa√ß√µes mais ricas.
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="report-card">
                            <div class="report-header">
                                <h2 class="report-title">‚ùå Erro no Processamento</h2>
                            </div>
                            <div style="padding: 20px;">
                                <p><strong>Erro:</strong> ${uploadResult.error}</p>
                                
                                <h3 style="margin-top: 20px; color: #ff6b35;">üìã Logs do Erro:</h3>
                                <div style="background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 8px; margin-top: 10px;">
                                    ${uploadResult.logs.map(log => `<div style="margin: 5px 0; font-family: monospace; font-size: 12px;">${log}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro no processamento de documentos:', error);
                resultsDiv.innerHTML = `
                    <div class="report-card">
                        <div class="report-header">
                            <h2 class="report-title">‚ùå Erro no Processamento</h2>
                        </div>
                        <div style="padding: 20px;">
                            <p><strong>Erro:</strong> ${error.message}</p>
                            <p>Verifique se o servidor est√° rodando e tente novamente.</p>
                        </div>
                    </div>
                `;
            }
        }

        async function generateThreatModel() {
            const systemName = document.getElementById('systemName').value;
            const systemType = document.getElementById('systemType').value;
            const sensitivity = document.getElementById('sensitivity').value;
            const description = document.getElementById('systemDescription').value;
            const assets = document.getElementById('assets').value;
            const aiModel = document.getElementById('aiModel').value;
            const documentsInput = document.getElementById('documents');

            if (!systemName || !description) {
                alert('Por favor, preencha pelo menos o nome e descri√ß√£o do sistema.');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading">Gerando an√°lise de amea√ßas no Z4l1nux AI Threat Lab...</div>';

            try {
                // Upload de documentos se houver
                if (documentsInput.files && documentsInput.files.length > 0) {
                    resultsDiv.innerHTML = '<div class="loading">üìÑ Fazendo upload de documentos...</div>';
                    
                    const formData = new FormData();
                    for (let i = 0; i < documentsInput.files.length; i++) {
                        formData.append('documents', documentsInput.files[i]);
                    }

                    const uploadResponse = await fetch('/api/upload-documents', {
                        method: 'POST',
                        body: formData
                    });

                    const uploadResult = await uploadResponse.json();
                    console.log('üìÑ Resultado do upload:', uploadResult);

                    if (!uploadResult.success) {
                        console.warn('‚ö†Ô∏è Upload de documentos falhou:', uploadResult.error);
                        // Continuar mesmo se o upload falhar
                    } else {
                        console.log('‚úÖ Documentos carregados com sucesso');
                    }
                }

                resultsDiv.innerHTML = '<div class="loading">üîç Analisando amea√ßas...</div>';

                // Usar o novo servi√ßo de threat modeling
                const request = {
                    systemName,
                    systemType,
                    sensitivity,
                    description,
                    assets: assets || 'N√£o especificados',
                    modelo: aiModel
                };

                console.log('üîç Enviando prompt de threat modeling para:', aiModel);
                const result = await window.threatModelingClient.generateThreatModeling(request);
                
                if (result.success) {
                    console.log('‚úÖ Processando resposta da IA');
                    const threats = window.threatModelingClient.processAIResponse(result.resposta, systemType);
                    generateReport(threats, systemName, systemType, sensitivity, description, assets);
                } else {
                    console.log('‚ùå Falha na resposta da IA, usando mock:', result.error);
                    generateMockReport(systemName, systemType, sensitivity, description, assets);
                }
            } catch (error) {
                console.error('‚ùå Erro na an√°lise de amea√ßas:', error);
                generateMockReport(systemName, systemType, sensitivity, description, assets);
            }
        }

        function generateMockReport(systemName, systemType, sensitivity, description, assets) {
            console.log('üîÑ Gerando relat√≥rio mock como fallback');
            const threats = window.threatModelingClient.getMockThreatsForSystem(systemType);
            generateReport(threats, systemName, systemType, sensitivity, description, assets);
        }

        function generateReport(threats, systemName, systemType, sensitivity, description, assets) {
            const resultsDiv = document.getElementById('results');
            const attackTreeDiagram = generateAttackTree(systemName, threats);
            const summaryStats = calculateStats(threats);
            
            resultsDiv.innerHTML = `
                <div class="report-card">
                    <div class="report-header">
                        <h2 class="report-title">üå≥ √Årvore de Ataque</h2>
                        <button class="export-btn" onclick="exportReport()">üìÑ Exportar PDF</button>
                    </div>
                    <div class="attack-tree">
                        <div class="mermaid">${attackTreeDiagram}</div>
                        </div>
                    </div>
                    
                <div class="report-card">
                    <div class="report-header">
                        <h2 class="report-title">üìã An√°lise Detalhada de Amea√ßas</h2>
                    </div>
                    <div class="summary-stats">
                        <div class="stat-card">
                            <div class="stat-number">${threats.length}</div>
                            <div class="stat-label">Total de Amea√ßas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summaryStats.critical}</div>
                            <div class="stat-label">Severidade Cr√≠tica</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summaryStats.high}</div>
                            <div class="stat-label">Severidade Alta</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summaryStats.medium}</div>
                            <div class="stat-label">Severidade M√©dia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summaryStats.low}</div>
                            <div class="stat-label">Severidade Baixa</div>
                        </div>
                    </div>
                    ${generateThreatTable(threats)}
                </div>
            `;

            // Re-inicializar Mermaid para renderizar o novo diagrama
            mermaid.init(undefined, document.querySelectorAll('.mermaid'));
        }

        function generateAttackTree(systemName, threats) {
            const strideColors = { 'S': '#3b82f6', 'T': '#8b5cf6', 'R': '#ef4444', 'I': '#10b981', 'D': '#f59e0b', 'E': '#6366f1' };
            
            let diagram = `graph TD\n                A["üéØ ${systemName}"]`;
            let connections = [];
            let classes = [];
            let criticalClasses = [];
            
            const strideCategories = {
                'S': { name: 'üîë Spoofing', threats: [] },
                'T': { name: 'üîß Tampering', threats: [] },
                'R': { name: 'üìú Repudiation', threats: [] },
                'I': { name: 'üìä Information Disclosure', threats: [] },
                'D': { name: 'üö´ Denial of Service', threats: [] },
                'E': { name: '‚¨ÜÔ∏è Elevation of Privilege', threats: [] }
            };
            
            threats.forEach((threat, index) => {
                if (threat.stride && Array.isArray(threat.stride)) {
                    threat.stride.forEach(category => {
                        if (strideCategories[category]) {
                            strideCategories[category].threats.push({
                                id: `T${index + 1}`,
                                name: threat.ameaca || threat.categoria || 'Amea√ßa',
                                severity: threat.severidade || 'M√©dia'
                            });
                        }
                    });
                }
            });
            
            Object.entries(strideCategories).forEach(([key, category]) => {
                if (category.threats.length > 0) {
                    connections.push(`A --> ${key}`);
                    connections.push(`${key}["${category.name}"]`);
                    
                    category.threats.forEach(threat => {
                        connections.push(`${key} --> ${threat.id}["${threat.name}"]`);
                        
                        if (threat.severity.toLowerCase() === 'cr√≠tica') {
                            criticalClasses.push(threat.id);
                        } else if (threat.severity.toLowerCase() === 'alta') {
                            classes.push(threat.id);
                        }
                    });
                }
            });
            
            diagram += '\n                ' + connections.join('\n                ');
            
            diagram += `
                classDef critical fill:#dc2626,stroke:#991b1b,stroke-width:3px,color:#fff
                classDef high fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
                classDef medium fill:#d97706,stroke:#92400e,stroke-width:2px,color:#fff
                classDef low fill:#059669,stroke:#065f46,stroke-width:2px,color:#fff`;
            
            if (criticalClasses.length > 0) {
                diagram += `\n                class ${criticalClasses.join(',')} critical`;
            }
            
            if (classes.length > 0) {
                diagram += `\n                class ${classes.join(',')} high`;
            }
            
            return diagram;
        }

        function generateThreatTable(threats) {
            const strideColors = { 'S': '#3b82f6', 'T': '#8b5cf6', 'R': '#ef4444', 'I': '#10b981', 'D': '#f59e0b', 'E': '#6366f1' };
            
            const tableRows = threats.map(threat => {
                const strideTags = threat.stride.map(s => 
                    `<span class="stride-tag" style="background-color: ${strideColors[s]}20; color: ${strideColors[s]};">${s}</span>`
                ).join('');
                
                const severityClass = threat.severidade.toLowerCase() === 'cr√≠tica' ? 'severity-critical' : 
                                      threat.severidade.toLowerCase() === 'alta' ? 'severity-high' : 
                                      threat.severidade.toLowerCase() === 'm√©dia' ? 'severity-medium' : 'severity-low';
                
                return `
                    <tr>
                    <td>${threat.id}</td>
                    <td>${strideTags}</td>
                    <td>${threat.categoria}</td>
                        <td>${threat.ameaca}</td>
                    <td>${threat.descricao}</td>
                    <td>${threat.impacto}</td>
                    <td>${threat.probabilidade}</td>
                    <td><span class="${severityClass}">${threat.severidade}</span></td>
                    <td>${threat.mitigacao}</td>
                    <td>${threat.capec}</td>
                    <td>${threat.deteccao}</td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="threat-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>STRIDE</th>
                            <th>Categoria</th>
                            <th>Amea√ßa</th>
                            <th>Descri√ß√£o</th>
                            <th>Impacto</th>
                            <th>Probabilidade</th>
                            <th>Severidade</th>
                            <th>Mitiga√ß√£o</th>
                            <th>CAPEC</th>
                            <th>Detec√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        function calculateStats(threats) {
            const stats = { critical: 0, high: 0, medium: 0, low: 0 };
            
            threats.forEach(threat => {
                const severity = threat.severidade.toLowerCase();
                if (severity === 'cr√≠tica') stats.critical++;
                else if (severity === 'alta') stats.high++;
                else if (severity === 'm√©dia') stats.medium++;
                else stats.low++;
            });
            
            return stats;
        }

        async function exportReport() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Capturar todo o conte√∫do dos resultados
            const resultsSection = document.getElementById('results');
            if (!resultsSection) {
                alert('Nenhum relat√≥rio encontrado para exportar.');
                return;
            }
            
            // Adicionar t√≠tulo do relat√≥rio
            pdf.setFontSize(20);
            pdf.setTextColor(255, 107, 53); // Cor laranja
            pdf.text('Relat√≥rio de An√°lise de Amea√ßas', 20, 20);
            
            // Adicionar data
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
            
            // Capturar cada se√ß√£o do relat√≥rio
            const reportCards = resultsSection.querySelectorAll('.report-card');
            let yPosition = 40;
            
            for (let i = 0; i < reportCards.length; i++) {
                const card = reportCards[i];
                
                // Adicionar quebra de p√°gina se necess√°rio
                if (yPosition > 250) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                // Capturar a se√ß√£o como imagem
                const canvas = await html2canvas(card, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#0f1419'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Verificar se cabe na p√°gina
                if (yPosition + imgHeight > 280) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                pdf.addImage(imgData, 'PNG', 10, yPosition, imgWidth, imgHeight);
                yPosition += imgHeight + 10;
            }
            
            // Salvar o PDF
            pdf.save('relatorio-analise-ameacas.pdf');
        }
    </script>
</body>
</html> 
