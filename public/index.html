<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Modelagem de Amea√ßas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%); color: #e8eaed; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; background: linear-gradient(135deg, #ff6b35, #f7931e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.8; color: #94a3b8; }
        .input-section { background: rgba(30, 41, 59, 0.6); border-radius: 16px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #f1f5f9; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid rgba(148, 163, 184, 0.2); background: rgba(15, 23, 42, 0.8); color: #e8eaed; font-size: 14px; transition: all 0.3s ease; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: #ff6b35; box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1); }
        .input-group textarea { min-height: 120px; resize: vertical; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .generate-btn { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 15px 30px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: block; margin: 0 auto; min-width: 200px; }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .results-section { margin-top: 40px; }
        .report-card { background: rgba(30, 41, 59, 0.6); border-radius: 16px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
        .report-title { color: #ff6b35; font-size: 1.5rem; font-weight: 600; }
        .export-btn { background: rgba(34, 197, 94, 0.8); color: white; padding: 8px 16px; border-radius: 8px; border: none; font-size: 14px; cursor: pointer; transition: all 0.3s ease; }
        .export-btn:hover { background: rgba(34, 197, 94, 1); }
        .attack-tree { background: rgba(15, 23, 42, 0.8); border-radius: 12px; padding: 20px; margin: 20px 0; }
        .threat-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(15, 23, 42, 0.8); border-radius: 12px; overflow: hidden; }
        .threat-table th { background: rgba(255, 107, 53, 0.2); padding: 15px 12px; text-align: left; font-weight: 600; color: #ff6b35; font-size: 14px; }
        .threat-table td { padding: 15px 12px; border-bottom: 1px solid rgba(148, 163, 184, 0.1); vertical-align: top; font-size: 13px; line-height: 1.4; }
        .threat-table tr:hover { background: rgba(255, 107, 53, 0.05); }
        .severity-high { background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .severity-medium { background: rgba(245, 158, 11, 0.2); color: #fcd34d; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .severity-low { background: rgba(34, 197, 94, 0.2); color: #86efac; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .stride-tag { background: rgba(59, 130, 246, 0.2); color: #93c5fd; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-right: 4px; display: inline-block; margin-bottom: 2px; }
        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255, 107, 53, 0.3); border-radius: 50%; border-top-color: #ff6b35; animation: spin 1s ease-in-out infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: rgba(15, 23, 42, 0.8); padding: 20px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #ff6b35; margin-bottom: 5px; }
        .stat-label { color: #94a3b8; font-size: 14px; }
        .model-selector { background: rgba(15, 23, 42, 0.8); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(148, 163, 184, 0.1); }
        .model-selector label { display: block; font-weight: 600; margin-bottom: 8px; color: #f1f5f9; }
        .model-selector select { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid rgba(148, 163, 184, 0.2); background: rgba(30, 41, 59, 0.8); color: #e8eaed; font-size: 14px; }
        /* Estilos para upload de documentos */
        .upload-area {
            border: 2px dashed rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(15, 23, 42, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #ff6b35;
            background: rgba(15, 23, 42, 0.6);
        }
        
        .upload-area.dragover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            transform: scale(1.02);
        }
        
        .upload-content h3 {
            color: #e8eaed;
            margin: 15px 0 10px 0;
            font-size: 1.2rem;
        }
        
        .upload-content p {
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .upload-btn, .process-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .upload-btn:hover, .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }
        
        .uploaded-files {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 1.2rem;
        }
        
        .file-name {
            color: #e8eaed;
            font-weight: 500;
        }
        
        .file-size {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .remove-file {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-file:hover {
            background: rgba(239, 68, 68, 1);
        }
        
        .upload-progress {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
            text-align: center;
        }
        
        .progress-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 107, 53, 0.3);
            border-radius: 50%;
            border-top-color: #ff6b35;
            animation: spin 1s ease-in-out infinite;
        }
        
        .upload-results {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .upload-success {
            color: #10b981;
            border-left: 4px solid #10b981;
            padding-left: 15px;
        }
        
        .upload-error {
            color: #ef4444;
            border-left: 4px solid #ef4444;
            padding-left: 15px;
        }
        
        .log-item {
            padding: 5px 0;
            color: #94a3b8;
            font-family: monospace;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) { .input-grid { grid-template-columns: 1fr; } .container { padding: 15px; } .header h1 { font-size: 2rem; } .threat-table { font-size: 12px; } .threat-table th, .threat-table td { padding: 10px 8px; } .upload-area { padding: 30px 15px; } .upload-content h3 { font-size: 1rem; } .file-item { flex-direction: column; align-items: flex-start; gap: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Sistema de Modelagem de Amea√ßas</h1>
            <p>An√°lise automatizada de amea√ßas com base no framework STRIDE e cat√°logo CAPEC</p>
        </div>

            <div class="input-section">
            <div class="model-selector">
                <label for="aiModel">Modelo de IA para An√°lise:</label>
                <select id="aiModel">
                        <option value="">Carregando modelos...</option>
                    </select>
                </div>
        </div>
        
        <!-- Se√ß√£o de Upload de Documentos -->
        <div class="input-section">
            <div class="section-header">
                <h2 style="color: #ff6b35; margin-bottom: 15px;">üìö Documentos de Contexto (Opcional)</h2>
                <p style="color: #94a3b8; margin-bottom: 20px;">Envie documentos sobre o sistema para enriquecer a an√°lise de amea√ßas. A IA utilizar√° essas informa√ß√µes para gerar um relat√≥rio mais preciso e contextualizado.</p>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-content">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Arraste arquivos aqui ou clique para selecionar</h3>
                    <p>Suporte: PDF, TXT, MD, DOCX (at√© 50MB por arquivo)</p>
                    <input type="file" id="documentUpload" multiple accept=".pdf,.txt,.md,.docx,.doc" style="display: none;" />
                    <button type="button" class="upload-btn" onclick="document.getElementById('documentUpload').click()">
                        üìÅ Selecionar Arquivos
                    </button>
                </div>
                </div>

            <div id="uploadedFiles" class="uploaded-files" style="display: none;">
                <h4 style="color: #ff6b35; margin-bottom: 10px;">Arquivos Selecionados:</h4>
                <div id="filesList"></div>
                <button type="button" class="process-btn" onclick="uploadDocuments()">
                    üöÄ Processar Documentos
                </button>
            </div>
            
            <div id="uploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-content">
                    <div class="loading-spinner"></div>
                    <p id="progressText">Processando documentos...</p>
                </div>
            </div>

            <div id="uploadResults" class="upload-results" style="display: none;"></div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="systemName">Nome do Sistema</label>
                <input type="text" id="systemName" placeholder="Ex: Sistema de E-commerce Corporativo" />
                </div>

            <div class="input-grid">
                <div class="input-group">
                    <label for="systemType">Tipo de Sistema</label>
                    <select id="systemType">
                        <option value="web">Aplica√ß√£o Web</option>
                        <option value="mobile">Aplica√ß√£o Mobile</option>
                        <option value="api">API/Microservi√ßos</option>
                        <option value="desktop">Aplica√ß√£o Desktop</option>
                        <option value="iot">Sistema IoT</option>
                        <option value="cloud">Infraestrutura Cloud</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="sensitivity">N√≠vel de Sensibilidade</label>
                    <select id="sensitivity">
                        <option value="public">P√∫blico</option>
                        <option value="internal">Interno</option>
                        <option value="confidential">Confidencial</option>
                        <option value="restricted">Restrito</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label for="systemDescription">Descri√ß√£o Detalhada do Sistema</label>
                <textarea id="systemDescription" placeholder="Descreva detalhadamente o sistema, suas funcionalidades, arquitetura, componentes, fluxos de dados, usu√°rios, integra√ß√µes externas, tecnologias utilizadas, e qualquer informa√ß√£o relevante para a modelagem de amea√ßas..."></textarea>
            </div>
            
            <div class="input-group">
                <label for="assets">Principais Ativos (opcional)</label>
                <textarea id="assets" placeholder="Liste os principais ativos do sistema: dados pessoais, informa√ß√µes financeiras, propriedade intelectual, etc."></textarea>
            </div>
            
            <button class="generate-btn" onclick="generateThreatModel()">
                üöÄ Gerar Modelo de Amea√ßas
            </button>
        </div>
        
        <div id="results" class="results-section" style="display: none;"></div>
    </div>

    <script>
        mermaid.initialize({
            theme: 'dark',
            themeVariables: {
                primaryColor: '#ff6b35',
                primaryTextColor: '#e8eaed',
                primaryBorderColor: '#ff6b35',
                lineColor: '#94a3b8',
                sectionBkgColor: 'rgba(30, 41, 59, 0.8)',
                altSectionBkgColor: 'rgba(15, 23, 42, 0.8)',
                gridColor: 'rgba(148, 163, 184, 0.2)',
                tertiaryColor: 'rgba(59, 130, 246, 0.2)'
            }
        });

        async function generateThreatModel() {
            const systemName = document.getElementById('systemName').value;
            const systemType = document.getElementById('systemType').value;
            const sensitivity = document.getElementById('sensitivity').value;
            const description = document.getElementById('systemDescription').value;
            const assets = document.getElementById('assets').value;
            const aiModel = document.getElementById('aiModel').value;

            if (!systemName || !description) {
                alert('Por favor, preencha pelo menos o nome e descri√ß√£o do sistema.');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading">Gerando modelo de amea√ßas...</div>';

            try {
                const threatAnalysisPrompt = `
Voc√™ √© um especialista em seguran√ßa cibern√©tica. Analise o sistema descrito abaixo e gere uma an√°lise de amea√ßas STRIDE baseada nos documentos da base de conhecimento.

SISTEMA PARA AN√ÅLISE:
- Nome: ${systemName}
- Tipo: ${systemType}
- N√≠vel de Sensibilidade: ${sensitivity}
- Descri√ß√£o: ${description}
- Ativos Principais: ${assets || 'N√£o especificados'}

INSTRU√á√ïES CR√çTICAS:
1. Use OBRIGATORIAMENTE informa√ß√µes da base de conhecimento sobre este tipo de sistema
2. Consulte especificamente o mapeamento STRIDE-CAPEC dispon√≠vel na base de conhecimento
3. Para cada amea√ßa identificada, use CAPECs REAIS da base de dados, n√£o invente c√≥digos CAPEC
4. Identifique amea√ßas espec√≠ficas baseadas nas tecnologias mencionadas na descri√ß√£o do sistema
5. Responda APENAS com um JSON v√°lido no formato especificado abaixo

MAPEAMENTO STRIDE OBRIGAT√ìRIO:
- S (Spoofing): Use CAPECs relacionados a falsifica√ß√£o de identidade da base
- T (Tampering): Use CAPECs relacionados a altera√ß√£o n√£o autorizada da base  
- R (Repudiation): Use CAPECs relacionados a nega√ß√£o de a√ß√µes da base
- I (Information Disclosure): Use CAPECs relacionados a exposi√ß√£o de dados da base
- D (Denial of Service): Use CAPECs relacionados a nega√ß√£o de servi√ßo da base
- E (Elevation of Privilege): Use CAPECs relacionados a escala√ß√£o de privil√©gios da base

FORMATO DE RESPOSTA (JSON):
{
  "threats": [
    {
      "id": "T001",
      "stride": ["S"],
      "categoria": "Nome da categoria",
      "ameaca": "T√≠tulo da amea√ßa espec√≠fica para este sistema",
      "descricao": "Descri√ß√£o detalhada considerando as tecnologias espec√≠ficas do sistema",
      "impacto": "Descri√ß√£o do impacto no contexto deste sistema",
      "probabilidade": "Alta/M√©dia/Baixa",
      "severidade": "Alta/M√©dia/Baixa", 
      "mitigacao": "Recomenda√ß√µes espec√≠ficas baseadas na arquitetura descrita",
      "capec": "CAPEC-XXX (usar apenas c√≥digos REAIS da base de conhecimento)",
      "deteccao": "Como detectar esta amea√ßa neste tipo de sistema"
    }
  ]
}`;

                console.log('üîç Enviando prompt de threat modeling para:', aiModel);
                
                const response = await fetch('/api/perguntar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pergunta: threatAnalysisPrompt, modelo: aiModel })
                });

                const data = await response.json();
                console.log('üì° Resposta recebida:', data);
                
                if (data.success && data.resposta) {
                    console.log('‚úÖ Processando resposta da IA');
                    processThreatAnalysis(data.resposta, systemName, systemType, sensitivity, description, assets);
                } else {
                    console.log('‚ùå Falha na resposta da IA, usando mock:', data.error || 'Erro desconhecido');
                    generateMockReport(systemName, systemType, sensitivity, description, assets);
                }
            } catch (error) {
                console.error('‚ùå Erro na an√°lise de amea√ßas:', error);
                generateMockReport(systemName, systemType, sensitivity, description, assets);
            }
        }

        function processThreatAnalysis(aiResponse, systemName, systemType, sensitivity, description, assets) {
            try {
                console.log('üîç Processando resposta da IA:', aiResponse.substring(0, 200) + '...');
                
                let threats = [];
                
                // Primeiro, tentar parsear diretamente como JSON
                try {
                    const directParse = JSON.parse(aiResponse);
                    threats = directParse.threats || directParse.ameacas || [];
                    console.log('‚úÖ JSON parseado diretamente, threats encontradas:', threats.length);
                } catch (e) {
                    console.log('‚ö†Ô∏è Parsing direto falhou, procurando JSON na resposta...');
                    
                    // Se falhar, procurar JSON dentro da resposta
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        console.log('üîç JSON encontrado na resposta:', jsonMatch[0].substring(0, 100) + '...');
                        const parsed = JSON.parse(jsonMatch[0]);
                        threats = parsed.threats || parsed.ameacas || [];
                        console.log('‚úÖ JSON extra√≠do, threats encontradas:', threats.length);
                    } else {
                        console.log('‚ùå Nenhum JSON v√°lido encontrado na resposta');
                        throw new Error('Nenhum JSON encontrado');
                    }
                }
                
                if (threats.length === 0) {
                    console.log('‚ö†Ô∏è Nenhuma amea√ßa encontrada, usando mock');
                    threats = getMockThreatsForSystem(systemType);
                }
                
                console.log('üéØ Gerando relat√≥rio com', threats.length, 'amea√ßas');
                generateReport(threats, systemName, systemType, sensitivity, description, assets);
                
            } catch (error) {
                console.error('‚ùå Erro ao processar resposta da IA:', error);
                console.log('üîÑ Usando dados mock como fallback');
                generateMockReport(systemName, systemType, sensitivity, description, assets);
            }
        }

        function generateMockReport(systemName, systemType, sensitivity, description, assets) {
            console.log('üîÑ Gerando relat√≥rio mock como fallback');
            const threats = getMockThreatsForSystem(systemType);
            generateReport(threats, systemName, systemType, sensitivity, description, assets);
        }

        function getMockThreatsForSystem(systemType) {
            const baseThreats = [
                { id: 'T001', stride: ['S', 'I'], categoria: 'Autentica√ß√£o', ameaca: 'Ataques de for√ßa bruta contra sistema de login', descricao: 'Atacantes podem tentar quebrar senhas atrav√©s de ataques automatizados de for√ßa bruta', impacto: 'Comprometimento de contas de usu√°rios e acesso n√£o autorizado ao sistema', probabilidade: 'M√©dia', severidade: 'Alta', mitigacao: 'Implementar bloqueio de conta ap√≥s tentativas falhidas, CAPTCHA, autentica√ß√£o multifator', capec: 'CAPEC-16, CAPEC-49', deteccao: 'Monitoramento de tentativas de login falhidas consecutivas' },
                { id: 'T002', stride: ['T'], categoria: 'Integridade de Dados', ameaca: 'Manipula√ß√£o de par√¢metros de requisi√ß√£o', descricao: 'Modifica√ß√£o n√£o autorizada de par√¢metros HTTP para alterar comportamento da aplica√ß√£o', impacto: 'Altera√ß√£o n√£o autorizada de dados ou bypass de controles de seguran√ßa', probabilidade: 'Alta', severidade: 'M√©dia', mitigacao: 'Valida√ß√£o robusta de entrada, assinatura de tokens, controle de integridade', capec: 'CAPEC-137, CAPEC-160', deteccao: 'Monitoramento de anomalias em par√¢metros de requisi√ß√£o' },
                { id: 'T003', stride: ['I'], categoria: 'Exposi√ß√£o de Dados', ameaca: 'Vazamento de informa√ß√µes atrav√©s de logs', descricao: 'Dados sens√≠veis podem ser expostos atrav√©s de logs de sistema mal configurados', impacto: 'Exposi√ß√£o de informa√ß√µes confidenciais e dados pessoais', probabilidade: 'M√©dia', severidade: 'M√©dia', mitigacao: 'Configura√ß√£o adequada de logs, sanitiza√ß√£o de dados sens√≠veis, controle de acesso aos logs', capec: 'CAPEC-117, CAPEC-204', deteccao: 'Auditoria regular dos logs e configura√ß√µes de logging' },
                { id: 'T004', stride: ['R'], categoria: 'Nega√ß√£o de Servi√ßo', ameaca: 'Ataques de DDoS na camada de aplica√ß√£o', descricao: 'Sobrecarga intencional do sistema atrav√©s de requisi√ß√µes maliciosas', impacto: 'Indisponibilidade do servi√ßo e degrada√ß√£o da performance', probabilidade: 'Alta', severidade: 'Alta', mitigacao: 'Rate limiting, WAF, CDN, monitoramento de tr√°fego', capec: 'CAPEC-125, CAPEC-130', deteccao: 'Monitoramento de m√©tricas de performance e padr√µes de tr√°fego' },
                { id: 'T005', stride: ['E'], categoria: 'Auditoria', ameaca: 'Aus√™ncia de trilhas de auditoria', descricao: 'Falta de logs adequados para rastreamento de a√ß√µes cr√≠ticas', impacto: 'Impossibilidade de investigar incidentes ou detectar atividades suspeitas', probabilidade: 'M√©dia', severidade: 'M√©dia', mitigacao: 'Implementa√ß√£o de logging abrangente, prote√ß√£o de logs, reten√ß√£o adequada', capec: 'CAPEC-13', deteccao: 'Verifica√ß√£o regular da completude dos logs de auditoria' }
            ];

            if (systemType === 'web') return baseThreats.filter(t => ['T001', 'T002', 'T004'].includes(t.id));
            if (systemType === 'api') return baseThreats.filter(t => ['T002', 'T003', 'T004'].includes(t.id));
            if (systemType === 'mobile') return baseThreats.filter(t => ['T001', 'T003', 'T005'].includes(t.id));
            return baseThreats;
        }

        function generateReport(threats, systemName, systemType, sensitivity, description, assets) {
            const resultsDiv = document.getElementById('results');
            const attackTreeDiagram = generateAttackTree(systemName, threats);
            const summaryStats = calculateStats(threats);
            
            resultsDiv.innerHTML = `
                <div class="report-card">
                    <div class="report-header">
                        <h2 class="report-title">üìä Relat√≥rio de Modelagem de Amea√ßas</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="export-btn" onclick="exportAttackTree()" style="background: rgba(59, 130, 246, 0.8);">üå≥ Ver √Årvore Interativa</button>
                            <button class="export-btn" onclick="exportReport()" style="background: rgba(34, 197, 94, 0.8);">üìÑ Exportar HTML</button>
                            <button class="export-btn" onclick="exportPDF()" style="background: rgba(239, 68, 68, 0.8);">üìã Exportar PDF</button>
                        </div>
                    </div>
                    
                    <div class="summary-stats">
                        <div class="stat-card"><div class="stat-number">${summaryStats.total}</div><div class="stat-label">Amea√ßas Identificadas</div></div>
                        <div class="stat-card"><div class="stat-number">${summaryStats.high}</div><div class="stat-label">Severidade Alta</div></div>
                        <div class="stat-card"><div class="stat-number">${summaryStats.medium}</div><div class="stat-label">Severidade M√©dia</div></div>
                        <div class="stat-card"><div class="stat-number">${summaryStats.stride.length}</div><div class="stat-label">Categorias STRIDE</div></div>
                    </div>

                    <h3 style="color: #ff6b35; margin: 30px 0 15px 0;">üå≥ √Årvore de Ataque</h3>
                    <div class="attack-tree"><div id="attackTreeDiagram">${attackTreeDiagram}</div></div>

                    <h3 style="color: #ff6b35; margin: 30px 0 15px 0;">üìã An√°lise Detalhada de Amea√ßas</h3>
                    ${generateThreatTable(threats)}
                </div>
            `;

            // Armazenar o c√≥digo Mermaid para export
            document.getElementById('attackTreeDiagram').setAttribute('data-mermaid', attackTreeDiagram);
            
            mermaid.render('attackTree', attackTreeDiagram).then(result => {
                document.getElementById('attackTreeDiagram').innerHTML = result.svg;
            });
        }

        function generateAttackTree(systemName, threats) {
            // Gerar √°rvore baseada nas amea√ßas espec√≠ficas da IA
            const strideCategories = {
                'S': { name: 'üîë Spoofing', threats: [] },
                'T': { name: 'üîß Tampering', threats: [] },
                'R': { name: 'üìú Repudiation', threats: [] },
                'I': { name: 'üìä Information Disclosure', threats: [] },
                'D': { name: '‚ö° Denial of Service', threats: [] },
                'E': { name: 'üë§ Elevation of Privilege', threats: [] }
            };
            
            // Agrupar amea√ßas por categoria STRIDE
            threats.forEach((threat, index) => {
                if (threat.stride && Array.isArray(threat.stride)) {
                    threat.stride.forEach(category => {
                        if (strideCategories[category]) {
                            strideCategories[category].threats.push({
                                id: `T${index + 1}`,
                                name: threat.ameaca || threat.categoria || 'Amea√ßa',
                                severity: threat.severidade || 'M√©dia'
                            });
                        }
                    });
                }
            });
            
            let diagram = `graph TD\n                A["üéØ ${systemName}"]`;
            let connections = [];
            let classes = [];
            
            // Gerar n√≥s e conex√µes para cada categoria STRIDE que tem amea√ßas
            Object.keys(strideCategories).forEach((key, categoryIndex) => {
                const category = strideCategories[key];
                if (category.threats.length > 0) {
                    const categoryId = `CAT_${key}`;
                    diagram += ` --> ${categoryId}["${category.name}"]`;
                    
                    category.threats.forEach((threat, threatIndex) => {
                        const threatId = `${categoryId}_${threatIndex}`;
                        connections.push(`                ${categoryId} --> ${threatId}["${threat.name}"]`);
                        
                        // Aplicar classes de severidade
                        if (threat.severity === 'Alta') {
                            classes.push(threatId);
                        }
                    });
                }
            });
            
            // Adicionar conex√µes
            if (connections.length > 0) {
                diagram += '\n\n' + connections.join('\n');
            }
            
            // Adicionar estilos
            diagram += `
                
                classDef high fill:#dc2626,stroke:#991b1b,stroke-width:2px,color:#fff
                classDef medium fill:#d97706,stroke:#92400e,stroke-width:2px,color:#fff
                classDef low fill:#059669,stroke:#065f46,stroke-width:2px,color:#fff`;
            
            // Aplicar classes de severidade alta
            if (classes.length > 0) {
                diagram += `\n                class ${classes.join(',')} high`;
            }
            
            return diagram;
        }

        function generateThreatTable(threats) {
            const strideColors = { 'S': '#3b82f6', 'T': '#8b5cf6', 'R': '#ef4444', 'I': '#10b981', 'D': '#f59e0b', 'E': '#6366f1' };
            
            const tableRows = threats.map(threat => {
                const strideTags = threat.stride.map(s => `<span class="stride-tag" style="background-color: ${strideColors[s]}20; color: ${strideColors[s]};">${s}</span>`).join('');
                const severityClass = threat.severidade.toLowerCase() === 'alta' ? 'severity-high' : threat.severidade.toLowerCase() === 'm√©dia' ? 'severity-medium' : 'severity-low';
                
                return `<tr>
                    <td>${threat.id}</td>
                    <td>${strideTags}</td>
                    <td>${threat.categoria}</td>
                    <td><strong>${threat.ameaca}</strong></td>
                    <td>${threat.descricao}</td>
                    <td>${threat.impacto}</td>
                    <td>${threat.probabilidade}</td>
                    <td><span class="${severityClass}">${threat.severidade}</span></td>
                    <td>${threat.mitigacao}</td>
                    <td>${threat.capec}</td>
                    <td>${threat.deteccao}</td>
                </tr>`;
            }).join('');

            return `<table class="threat-table">
                <thead><tr><th>ID</th><th>STRIDE</th><th>Categoria</th><th>Amea√ßa</th><th>Descri√ß√£o</th><th>Impacto</th><th>Probabilidade</th><th>Severidade</th><th>Mitiga√ß√£o</th><th>CAPEC</th><th>Detec√ß√£o</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>`;
        }

        function calculateStats(threats) {
            return {
                total: threats.length,
                high: threats.filter(t => t.severidade === 'Alta').length,
                medium: threats.filter(t => t.severidade === 'M√©dia').length,
                low: threats.filter(t => t.severidade === 'Baixa').length,
                stride: [...new Set(threats.flatMap(t => t.stride))]
            };
        }

        function exportReport() {
            const reportContent = document.querySelector('.report-card').outerHTML;
            const fullHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Relat√≥rio de Amea√ßas</title></head><body>' + reportContent + '</body></html>';
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio-ameacas-' + new Date().toISOString().split('T')[0] + '.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportAttackTree() {
            const attackTreeDiagram = document.querySelector('#attackTreeDiagram').getAttribute('data-mermaid');
            if (!attackTreeDiagram) {
                alert('‚ùå √Årvore de ataque n√£o encontrada. Gere o relat√≥rio primeiro.');
                return;
            }

            // Abrir o iframe avan√ßado em nova aba para export
            const encoded = btoa(encodeURIComponent(attackTreeDiagram));
            const url = `mermaid-iframe.html?diagram=${encoded}`;
            window.open(url, '_blank', 'width=1200,height=800');
        }

        async function exportPDF() {
            try {
                const originalContent = document.querySelector('.export-btn[onclick="exportPDF()"]').innerHTML;
                document.querySelector('.export-btn[onclick="exportPDF()"]').innerHTML = '‚è≥ Gerando PDF...';

                const reportCard = document.querySelector('.report-card');
                const canvas = await html2canvas(reportCard, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const ratio = Math.min(pdfWidth / canvas.width, pdfHeight / canvas.height);
                
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * ratio, canvas.height * ratio);
                pdf.save('relatorio-ameacas-' + new Date().toISOString().split('T')[0] + '.pdf');

                document.querySelector('.export-btn[onclick="exportPDF()"]').innerHTML = originalContent;
            } catch (error) {
                alert('‚ùå Erro ao gerar PDF. Tente a exporta√ß√£o HTML.');
            }
        }

        // Vari√°veis globais para upload
        let selectedFiles = [];

        // Fun√ß√µes de upload de documentos
        function setupUploadEvents() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('documentUpload');

            // Drag and drop events
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });

            // Clique na √°rea de upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Sele√ß√£o de arquivos via input
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
            });
        }

        function handleFileSelection(files) {
            // Filtrar arquivos por tipo e tamanho
            const validFiles = files.filter(file => {
                const validTypes = ['application/pdf', 'text/plain', 'text/markdown', 
                                  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                  'application/msword'];
                const validExtensions = /\.(pdf|txt|md|docx|doc)$/i;
                const maxSize = 50 * 1024 * 1024; // 50MB

                if (!validTypes.includes(file.type) && !validExtensions.test(file.name)) {
                    alert(`‚ùå Arquivo "${file.name}" n√£o √© suportado. Use PDF, TXT, MD ou DOCX.`);
                    return false;
                }

                if (file.size > maxSize) {
                    alert(`‚ùå Arquivo "${file.name}" √© muito grande. M√°ximo 50MB.`);
                    return false;
                }

                return true;
            });

            // Adicionar arquivos √† lista (evitar duplicatas)
            validFiles.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            displaySelectedFiles();
        }

        function displaySelectedFiles() {
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            const filesListDiv = document.getElementById('filesList');

            if (selectedFiles.length === 0) {
                uploadedFilesDiv.style.display = 'none';
                return;
            }

            uploadedFilesDiv.style.display = 'block';
            
            filesListDiv.innerHTML = selectedFiles.map((file, index) => {
                const fileIcon = getFileIcon(file.name);
                const fileSize = formatFileSize(file.size);
                
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon">${fileIcon}</span>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                        </div>
                        <button class="remove-file" onclick="removeFile(${index})">üóëÔ∏è Remover</button>
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'üìÑ';
                case 'txt': return 'üìù';
                case 'md': return 'üìã';
                case 'docx':
                case 'doc': return 'üìò';
                default: return 'üìÑ';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displaySelectedFiles();
        }

        async function uploadDocuments() {
            if (selectedFiles.length === 0) {
                alert('‚ùå Selecione ao menos um arquivo para processar.');
                return;
            }

            const progressDiv = document.getElementById('uploadProgress');
            const resultsDiv = document.getElementById('uploadResults');
            const progressText = document.getElementById('progressText');

            // Mostrar progresso
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            progressText.textContent = 'Enviando documentos...';

            try {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('documents', file);
                });

                progressText.textContent = 'Processando documentos com embeddings...';

                const response = await fetch('/api/upload-documents', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // Ocultar progresso
                progressDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="upload-success">
                            <h4>‚úÖ ${result.message}</h4>
                            <div style="margin-top: 15px;">
                                <strong>üìä Resumo:</strong><br>
                                üìÅ Arquivos enviados: ${result.summary.filesUploaded}<br>
                                üìÑ Documentos novos: ${result.summary.documentsAdded}<br>
                                ‚úèÔ∏è Documentos modificados: ${result.summary.documentsModified}<br>
                                üóëÔ∏è Documentos removidos: ${result.summary.documentsRemoved}
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>üìã Log do processamento:</strong>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                                    ${result.logs.map(log => `<div class="log-item">${log}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                    // Limpar arquivos selecionados ap√≥s sucesso
                    selectedFiles = [];
                    displaySelectedFiles();

                } else {
                    resultsDiv.innerHTML = `
                        <div class="upload-error">
                            <h4>‚ùå Erro no processamento</h4>
                            <p>${result.error}</p>
                            <div style="margin-top: 15px;">
                                <strong>üìã Log do erro:</strong>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                                    ${result.logs.map(log => `<div class="log-item">${log}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                progressDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div class="upload-error">
                        <h4>‚ùå Erro de conex√£o</h4>
                        <p>N√£o foi poss√≠vel conectar ao servidor: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Fun√ß√£o para carregar modelos dispon√≠veis
        async function loadAvailableModels() {
            try {
                console.log('üîÑ Carregando modelos dispon√≠veis...');
                const response = await fetch('/api/models');
                const data = await response.json();
                
                const aiModelSelect = document.getElementById('aiModel');
                aiModelSelect.innerHTML = ''; // Limpar op√ß√µes existentes
                
                // Adicionar modelos de chat dispon√≠veis
                data.chat.forEach(model => {
                    if (model.enabled) {
                        const option = document.createElement('option');
                        option.value = model.value;
                        option.textContent = model.name + (model.recommended ? ' - Recomendado' : '');
                        if (model.recommended) option.selected = true;
                        aiModelSelect.appendChild(option);
                    }
                });
                
                console.log(`‚úÖ ${data.chat.filter(m => m.enabled).length} modelos carregados`);
                console.log('üîß Embedding:', data.embedding.model, `(${data.embedding.provider})`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar modelos:', error);
                // Fallback para modelos padr√£o
                const aiModelSelect = document.getElementById('aiModel');
                aiModelSelect.innerHTML = `
                    <option value="1">ü§ñ Gemini (Google)</option>
                    <option value="2">ü¶ô Ollama (Local)</option>
                    <option value="3" selected>üß† DeepSeek (OpenRouter)</option>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Carregar modelos dispon√≠veis
            loadAvailableModels();
            
            // Configurar eventos de upload
            setupUploadEvents();

            // Anima√ß√£o de entrada
            const elements = document.querySelectorAll('.input-section, .header');
            elements.forEach((el, index) => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    el.style.transition = 'all 0.6s ease';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, index * 200);
            });
        });
    </script>
</body>
</html> 
